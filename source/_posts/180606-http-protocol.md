---
title:      "HTTP åè®®"
date:       2018-06-06
author:     "Bowen"
tags:
    - å‰ç«¯å¼€å‘
    - ç½‘ç»œè¯·æ±‚
---

## HTTP ä¸‰æ¬¡æ¡æ‰‹

`HTTP` è‡ªèº«æ²¡æœ‰å’Œ `server` ç«¯é€šä¿¡ä¼ è¾“çš„åŠŸèƒ½ï¼Œ`HTTP` æœ¬èº«åªèƒ½å‘èµ·å’Œå“åº”è¯·æ±‚ï¼Œå¹¶ä¸ä¼ è¾“è¯·æ±‚ã€‚ä»–æ˜¯é€šè¿‡åˆ›å»ºçš„ `TCP connection`ï¼ˆä½œä¸ºä¼ è¾“è¯·æ±‚çš„é€šé“ï¼‰æ¥å®ç°æ•°æ®ä¼ é€’åŠŸèƒ½ã€‚æ‰€æœ‰çš„ `HTTP` è¯·æ±‚åˆ›å»ºæ—¶ï¼Œéƒ½ä¼šåˆ›å»ºä¸€ä¸ª `TCP` é€šé“ç”¨äºæ•°æ®ä¼ è¾“ã€‚

  ![http-tcp][http-tcp]

[http-tcp]:https://rawgit.com/lbwa/lbwa.github.io/vue/source/images/post/http-protocol/http-tcp.svg

- `HTTP 1.0` æ—¶ï¼Œåœ¨ `HTTP` è¯·æ±‚åˆ›å»ºæ—¶ï¼ŒåŒæ ·ä¼šåˆ›å»ºä¸€ä¸ª `TCP` é€šé“ç”¨äºä¼ è¾“æ•°æ®ã€‚åœ¨æœåŠ¡ç«¯å“åº”è¯·æ±‚åï¼Œ`TCP` é€šé“å°±ä¼šå…³é—­ï¼ˆéå¸¸é©»ï¼‰ã€‚

- `HTTP 1.1` æ—¶ï¼Œå¯ ***é¢å¤–å£°æ˜*** è®©æœåŠ¡ç«¯å“åº”è¯·æ±‚åï¼Œ`TCP` ä»ä¿æŒé€šé“å¼€å¯ï¼ˆå¸¸é©»çŠ¶æ€ï¼‰ã€‚æ­¤ä¸¾ç”¨äºé¿å…å¤šæ¬¡è¯·æ±‚æ—¶ï¼Œä¸å¿…è¦çš„ `ä¸‰æ¬¡æ¡æ‰‹` æ€§èƒ½å¼€é”€ã€‚

    - ç°é˜¶æ®µä½¿ç”¨æœ€ä¸ºå¹¿æ³›çš„ `HTTP` åè®®ç‰ˆæœ¬ã€‚

- `HTTP 2` å¯å¹¶å‘è¯·æ±‚ï¼Œé‚£ä¹ˆåœ¨ä¿æŒ `TCP` é€šé“å¼€å¯æ—¶ï¼Œç›¸åŒç”¨æˆ·å¤šæ¬¡å¯¹åŒä¸€æœåŠ¡å™¨çš„å¹¶å‘è¯·æ±‚å¯å…±ç”¨ä¸€ä¸ª `TCP` é€šé“ã€‚

    - `HTTP 2` æ­£åœ¨é€æ­¥æ¨å¹¿ä¸­ã€‚ 

### ä¸‰æ¬¡æ¡æ‰‹

åœ¨ `HTTP` é€šè¿‡ `TCP` æ‰§è¡Œæ­£å¼çš„è¯·æ±‚ä¹‹å‰ï¼Œæœ‰ 3 æ¬¡é¢„å…ˆè¯·æ±‚å‘ç”Ÿåœ¨ `client` å’Œ `server` ç«¯ä¹‹é—´ã€‚

1. `client` åˆ›å»ºä¸€ä¸ªé¢„è¯·æ±‚ä»¥å‘ŠçŸ¥ `server`ï¼š`client` å³å°†å‘èµ·ä¸€ä¸ªæ­£å¼ `TCP` è¿æ¥ã€‚æ­¤æ¬¡è¯·æ±‚åŒ…å«æ ‡å¿—ä½ï¼ˆ`SYN=1,Seq=X`ï¼‰ã€‚

2. `server` å“åº” 1 ä¸­çš„é¢„è¯·æ±‚ï¼Œå¼€å¯ç›¸åº” `TCP` ç«¯å£ï¼Œå¹¶è¿”å›ä¸€ä¸ªå“åº”æ•°æ®åŒ…ï¼ˆ`SYN=1, ACK=X+1, Seq=Y`ï¼‰ç»™ `client`ã€‚

    - æ­¤æ¬¡ `server` è¿”å›æ•°æ®è¡¨ç¤º `server` ä¸ä»…èƒ½å¤Ÿæ­£å¸¸æ¥å— `client` çš„è¯·æ±‚ï¼Œè€Œä¸”å·²å¼€å¯ç›¸åº”ç«¯å£å‡†å¤‡æ¥æ”¶å³å°†åˆ°æ¥çš„æ­£å¼ `TCP` è¿æ¥ã€‚

    - æ­¤æ—¶ `server` ç«¯çš„ `TCP` ç«¯å£å°†ä¿æŒå¼€å¯è‡³å“åº” `client` è¯·æ±‚ï¼ˆ`client` å·²æ­£å¸¸æ¥æ”¶çš„è¯·æ±‚æˆ–å…³é—­å½“å‰ `TCP` è¿æ¥çš„è¯·æ±‚ï¼‰ã€‚

3. `client` åœ¨æ”¶åˆ° `server` ç«¯è¿”å›çš„å…è®¸åˆ›å»º `TCP` è¿æ¥çš„è¯·æ±‚ä¹‹åï¼Œå‘ `server` å‘é€å·²æ­£å¸¸æ¥æ”¶åˆ° 2 ä¸­çš„å“åº”æ•°æ®çš„è¯·æ±‚ï¼ˆ`ACK=Y+1, Seq=Z`ï¼‰ã€‚

    - æ­¤æ¬¡è¯·æ±‚è¡¨ç¤º `client` èƒ½å¤Ÿæ­£å¸¸æ¥å— `server` çš„å“åº”æ•°æ®ã€‚

æ­¤æ—¶ï¼Œå®Œæˆ `ä¸‰æ¬¡æ¡æ‰‹` é¢„è¯·æ±‚ï¼Œåˆ›å»ºæ­£å¼çš„ `TCP` è¯·æ±‚ã€‚

### ä¸‰æ¬¡æ¡æ‰‹çš„æ„ä¹‰

1. è‹¥æ²¡æœ‰ä¸‰æ¬¡æ¡æ‰‹ï¼Œç›´æ¥è¯·æ±‚ï¼Œé‚£ä¹ˆåœ¨ `server` è¿”å›æ•°æ®æ—¶ï¼Œ`server` å¹¶ä¸çŸ¥é“ `client` æ˜¯å¦èƒ½å¤Ÿæ­£ç¡®çš„æ¥å—åˆ°è¯·æ±‚ï¼Œæ˜¯å¦è¿‡ç¨‹ä¸­æœ‰æ•°æ®ä¸¢å¤±ï¼Œé‚£ä¹ˆ `server` å°±å¯èƒ½åœ¨é”™è¯¯çš„æ—¶æœºä»ç„¶ä¿æŒ `TCP` è¿æ¥ç«¯å£æ¥ç­‰å¾… `client` ç¡®è®¤æ•°æ®å·²æ¥å—çš„è¯·æ±‚æˆ–å…³é—­å½“å‰ `TCP` è¿æ¥çš„è¯·æ±‚ï¼Œè¿™æ ·å°†å¸¦æ¥ä¸€ç³»åˆ—ä¸å¿…è¦çš„ `server` æ€§èƒ½å¼€é”€ã€‚åœ¨ `client` ç­‰å¾…æ—¶é—´å†…æ²¡æœ‰æ­£ç¡®æ¥æ”¶è¯·æ±‚æ—¶ï¼Œ`client` å°±ä¼šå…³é—­ `TCP` è¿æ¥ã€‚é‚£ä¹ˆæ­¤æ—¶ `server` ä¹Ÿå°±æ²¡æœ‰å¿…è¦ä¸ºä¸ºæ— ç”¨çš„æ•°æ®è¿æ¥ç»§ç»­ä¿æŒå¼€å¯ç›¸åº” `TCP` è¿æ¥ç«¯å£ã€‚

2. åœ¨æœ‰äº†ä¸‰æ¬¡æ¡æ‰‹çš„ç­–ç•¥åï¼Œåœ¨æ­£å¼è¯·æ±‚ä¹‹å‰ï¼Œå°±å¯ä»¥ç¡®ä¿å½“å‰ `TCP` é€šé“æ˜¯å¯ç”¨çš„ï¼ŒåŠæ—¶å‘ç°å½“å‰ `TCP` çš„ç½‘ç»œé—®é¢˜ã€‚é¿å…å› ç½‘ç»œé—®é¢˜å¯¼è‡´çš„æ— ç”¨çš„æ•°æ®ä¼ è¾“å¸¦æ¥çš„ `server` ç«¯å£å¸¸é©»çš„æ€§èƒ½å¼€é”€ã€‚

## URI/URL/URN

`URI`: Uniform Resource Identifier ç»Ÿä¸€èµ„æºæ ‡å¿—ç¬¦

  - ç”¨äºå”¯ä¸€æ ‡è¯†äº’è”ç½‘ä¸­çš„ä¿¡æ¯èµ„æº

  - åŒ…å« `URL` å’Œ `URN`

`URL`: Uniform Resource Locator ç»Ÿä¸€èµ„æºå®šä½å™¨

  - æ ¼å¼å¦‚ä¸‹ï¼š

      `protocol://user:pass@host.com:80/path?query=string#hash`

      - `protocol` åè®®ã€‚å¦‚ `https`ã€`http`ã€`ftp` ç­‰ã€‚

      - `user:pass` ç”¨æˆ·éªŒè¯ã€‚å› æš´éœ²ç”¨æˆ·è´¦å·å¯†ç ä¸å®‰å…¨ï¼Œæ•…ä¸æ¨èä½¿ç”¨ã€‚

      - `host` ä¸»æœºåã€‚

      - `80` ä¸»æœºç«¯å£ï¼Œé»˜è®¤ä¸º `80`ã€‚æ¯ä¸ªç‰©ç†ä¸»æœºç«¯å£éƒ½å­˜æ”¾ç€ä¸åŒçš„ web æœåŠ¡ã€‚

      - `path` è·¯ç”±ã€‚
      
          1. `/` è¡¨ç¤ºå½“å‰ `web` æœåŠ¡çš„æ ¹ç›®å½•ï¼Œè€Œä¸æ˜¯ä¸»æœºçš„æ ¹ç›®å½•ã€‚
          
          2. `path` è·¯å¾„é»˜è®¤æƒ…å†µä¸‹ä¸º `web` æœåŠ¡å™¨ä¸‹æ•°æ®å­˜æ”¾çš„è·¯å¾„ã€‚å½“æ•°æ®åº“ç‹¬ç«‹æ—¶ï¼Œé‚£ä¹ˆ `path` ä»…è¡¨ç¤ºæ•°æ®çš„ ***å­˜æ”¾åœ°å€***ï¼Œå¹¶ä¸èƒ½è¡¨ç¤ºè¯¥æ•°æ®åœ¨æœåŠ¡å™¨ç£ç›˜ä¸Šçš„è·¯å¾„ã€‚

          3. æ•…æ¨èåœ¨ç¨‹åºå†…éƒ¨é‰´åˆ«æ•°æ®ï¼Œè€Œä¸æ˜¯é€šè¿‡ URL é‰´åˆ«æ•°æ®ã€‚

      - `query=string` æŸ¥è¯¢å‚æ•°ã€‚å¸¸ç”¨äºå‘ `server` ç«¯ä¼ å‚ã€‚

      - `hash` å“ˆå¸Œå€¼ã€‚å®šä½æŸä¸ªèµ„æºçš„æŸä¸€ç‰‡æ®µã€‚å¦‚æ–‡ç« çš„é”šç‚¹ã€‚

`URN`: Uniform Resource Name ï¼ˆæ°¸ä¹…ï¼‰ç»Ÿä¸€èµ„æºå®šä½ç¬¦

  - ç”¨äºæ°¸ä¹…æ€§åœ¨ç½‘ç»œä¸­æ ‡è¯†å‡ºèµ„æºï¼Œå› é™åˆ¶è¿‡å¤šï¼Œå·²é€æ¸è¢« `URI` å–ä»£ã€‚ï¼ˆ[extension][urn]ï¼‰

[urn]:https://en.wikipedia.org/wiki/Uniform_Resource_Name

## HTTP æŠ¥æ–‡

`HTTP` æŠ¥æ–‡æ²¡æœ‰å¼ºçº¦æŸï¼Œå¯è‡ªå®šä¹‰æŠ¥æ–‡å†…å®¹ã€‚

![http-bw][http-bw]

[http-bw]:https://rawgit.com/lbwa/lbwa.github.io/vue/source/images/post/http-protocol/http-bw.svg

## HTTP æ–¹æ³•

- ç”¨æ¥å®šä¹‰å¯¹äºèµ„æºçš„æ“ä½œ

    - å¸¸ç”¨æ–¹æ³•æœ‰ `GET`ã€`POST`ã€`PUT`ã€`DELETE`ã€‚å¦å¤–è¿˜æœ‰ `HEAD`ã€`OPTIONS`ã€`PATCH` æ–¹æ³•ã€‚

    - åº”è¯¥ä»å¼€å‘äººå‘˜çš„ä½¿ç”¨æ–¹å¼æ¥å®šä¹‰å„è‡ªæ–¹æ³•çš„è¯­ä¹‰ã€‚

## HTTP code

- å®šä¹‰æœåŠ¡å™¨å¯¹è¯·æ±‚çš„å¤„ç†ç»“æœã€‚

    - 2XX - Success - è¡¨ç¤ºæˆåŠŸå¤„ç†è¯·æ±‚ã€‚å¦‚ 200ã€‚

    - 3XX - Redirection - éœ€è¦é‡å®šå‘ï¼Œæµè§ˆå™¨ç›´æ¥è·³è½¬ã€‚

    - 4XX - Client Error - å®¢æˆ·ç«¯è¯·æ±‚é”™è¯¯ã€‚

    - 5XX - Server Error - æœåŠ¡ç«¯å“åº”é”™è¯¯ã€‚

- æ¨è `server` ç«¯æ­£ç¡®é…ç½® HTTP codeï¼Œä½¿å¾— HTTP code è¯­ä¹‰åŒ–ã€‚å¥½çš„ `HTTP` æœåŠ¡åº”è¯¥å¯ä»¥é€šè¿‡ HTTP code æ¥åˆ¤æ–­è¯·æ±‚ç»“æœã€‚è€Œä¸æ˜¯åªæœ‰ `200` æˆ– `500`ã€‚

æ‹“å±•ï¼š[code ç å‚è€ƒ][code-reference]

[code-reference]:http://tool.oschina.net/commons?type=5

## HTTP å®¢æˆ·ç«¯

èƒ½å¤Ÿå‘èµ· HTTP è¯·æ±‚ï¼Œå¹¶èƒ½å¤Ÿæ¥æ”¶è¿”å›æ•°æ®çš„å®¢æˆ·ç«¯éƒ½å¯ç§°ä¸º HTTP å®¢æˆ·ç«¯ã€‚å¦‚ `curl`ã€`XMLHttpRequest`ã€æµè§ˆå™¨ç­‰ã€‚

é™¤äº†åœ¨æµè§ˆå™¨ä¸­å¯ä»¥è§‚å¯Ÿ HTTP è¯·æ±‚çš„ç»†èŠ‚å¤–ï¼Œäº¦å¯ä½¿ç”¨ `curl` å‘½ä»¤è¡Œå·¥å…·æ¥è§‚å¯Ÿã€‚ 

```powershell
# -v è¡¨ç¤ºæ˜¾ç¤ºæŠ¥æ–‡ä¿¡æ¯
curl -v www.baidu.com
```

è¿”å›æ•°æ®å¦‚ä¸‹ï¼š

```powershell
* Rebuilt URL to: www.google.com/
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
  0     0    0     0    0     0      0      0 --:--:-- --:--:-- --:--:--     0*
  Trying 172.217.10.132...
* TCP_NODELAY set
* Connected to www.google.com (172.217.10.132) port 80 (#0)
# è¯·æ±‚æŠ¥æ–‡
  # èµ·å§‹è¡Œ
> GET / HTTP/1.1
  # é¦–éƒ¨
> Host: www.google.com
> User-Agent: curl/7.57.0
> Accept: */*
> # æ­¤å¤„æœ‰ä¸€ç©ºè¡Œ
# å“åº”æŠ¥æ–‡
  # èµ·å§‹è¡Œ
< HTTP/1.1 200 OK
  # é¦–éƒ¨
< Date: Thu, 07 Jun 2018 14:28:45 GMT
< Expires: -1
< Cache-Control: private, max-age=0
< Content-Type: text/html; charset=ISO-8859-1
# çœç•¥ä¸€äº›ä¿¡æ¯
# ...
< Transfer-Encoding: chunked
<
{ [759 bytes data]
100  3555    0  3555    0     0   3555      0 --:--:--  0:00:01 --:--:--  1834
# ä»¥ä¸‹æ˜¯å“åº”æŠ¥æ–‡çš„ä¸»ä½“å†…å®¹åŒºåŸŸ
# ...
<!doctype html><html
```

## HTTP é¦–éƒ¨

åœ¨å®ç° `HTTP` åè®®è¿‡ç¨‹ä¸­ï¼Œä¸€ç³»åˆ—åŠŸèƒ½éƒ½æ˜¯é€šè¿‡é…ç½®ç›¸åº”çš„ `HTTP` é¦–éƒ¨æ¥å®ç°çš„ã€‚

ğŸ‘‰[HTTP å“åº”é¦–éƒ¨][http-response]

ğŸ‘‰[HTTP è¯·æ±‚é¦–éƒ¨][http-request]

[http-response]:https://lbwa.github.io/blog/writings/180607-http-response/

[http-request]:https://lbwa.github.io/blog/writings/180608-http-request/

## å®æˆ˜

ï¼ˆä»¥ `Nginx` ä¸ºä¾‹ï¼‰

`Nginx`ï¼ˆ[å®˜ç½‘][nginx-official-site]ï¼‰çº¯ç²¹åœ°å®ç° `HTTP` åè®®ï¼Œå…¶ä¸­å¹¶ä¸åŒ…å«ä¸šåŠ¡é€»è¾‘ï¼Œæ­£å› å¦‚æ­¤å®ƒçš„ ***å¯æ‹“å±•æ€§å¼º***ã€‚

[nginx-official-site]:https://nginx.org/en/

### API

- `Nginx` API

API æ–‡æ¡£ï¼š[API Docs][Nginx-api]

å‘½ä»¤è¡Œå‚æ•°ï¼š[Command-line parameters][nginx-clp]

```powershell
# -c file ä½¿ç”¨ä¸€ä¸ªæŒ‡å®šçš„é…ç½®æ–‡ä»¶ä»£æ›¿é»˜è®¤é…ç½®æ–‡ä»¶ï¼Œé»˜è®¤å€¼ä¸º nginx/nginx.conf

# å¯åŠ¨æœåŠ¡
start nginx [-c confFile] # æ¨èï¼Œä½†é…ç½®æ–‡ä»¶å‡ºé”™æ—¶ï¼Œæ— æç¤ºä¿¡æ¯
# æˆ–è€…
./nginx [-c confFile] # ä¼šå ç”¨å½“å‰çª—å£ï¼Œä½†é…ç½®æ–‡ä»¶ä»å‡ºé”™æ—¶ï¼Œæœ‰æç¤ºä¿¡æ¯

# -s signal å‘é€ä¸€ä¸ª signal åˆ° nginx ä¸»è¿›ç¨‹
# signal å€¼ä¸º stop, quit, reload, reopen ä¹‹ä¸€

# é‡å¯æœåŠ¡
./nginx -s reload

# é€€å‡ºæœåŠ¡
./nginx -s stop # ç«‹å³åœæ­¢æœåŠ¡ï¼Œå¯èƒ½ä¸ä¼šä¿å­˜ç›¸å…³ä¿¡æ¯
./nginx -s quit # æœ‰åºåœ°åœæ­¢æœåŠ¡ï¼Œå¹¶ä¿å­˜ç›¸å…³ä¿¡æ¯

# -g directives å‘é€ä¸€ä¸ªå…¨å±€é…ç½®æŒ‡ä»¤
# HUP æŒ‡ä»¤ï¼Œä½¿ç”¨æ–°çš„é…ç½®æ–‡ä»¶å¯åŠ¨è¿›ç¨‹ï¼Œä¹‹åå¹³ç¼“åœæ­¢åŸæœ‰è¿›ç¨‹ï¼Œå³å¹³æ»‘é‡å¯

# å¹³æ»‘é‡å¯
./nginx -g HUP [-c newConfFile]

# -t æ£€æµ‹é…ç½®æ–‡ä»¶ã€‚ä½¿ç”¨åœºæ™¯ï¼šç”¨äºä¸Šçº¿å‰æ£€æµ‹ï¼Œé¿å…ä¸Šçº¿é”™è¯¯
./nginx -t -c sample.conf

# æŸ¥çœ‹å½“å‰ nginx è¿›ç¨‹å·
# logs/nginx.pid æ˜¯ nginx.pid çš„æ–‡ä»¶è·¯å¾„
cat logs/nginx.pid
```

- ç³»ç»Ÿ API

```powershell
# æŸ¥çœ‹ç«¯å£å ç”¨ï¼Œå¦‚ 8800 ç«¯å£
# -ano æ˜¯ä¸‰ä¸ªå‚æ•° -a -n -o ç®€å†™å½¢å¼
netstat -ano|findstr 8800

tasklist /? # å¸®åŠ©æ–‡æ¡£

# /fi filter æ˜¾ç¤ºä¸€ç³»åˆ—ç¬¦åˆç­›é€‰å™¨æŒ‡å®šçš„è¿›ç¨‹

# æŸ¥çœ‹å½“å‰ nginx è¿›ç¨‹
# å…¶ä¸­è¿ç®—ç¬¦ eq è¡¨ç¤º ç­‰äº
tasklist /fi "imagename eq nginx.exe" # cmd and powershell
tasklist //fi "imagename eq nginx.exe" # git bash for win

# ç»“æŸæ‰€æœ‰ nginx è¿›ç¨‹

tskill nginx # æ¨è

# /f å¼ºè¡Œç»ˆæ­¢
taskkill /fi "imagename eq nginx.exe" /f # cmd and powershell
taskkill //fi "imagename eq nginx.exe" //f # git bash for win

# ä¸ pid é…åˆä½¿ç”¨
cat logs/nginx.pid # å¾—åˆ° Nginx ä¸»è¿›ç¨‹ PID å€¼ pidNumber
taskkill //pid pidNumber //f
```

æ³¨ï¼š`tasklist` å’Œ `taskkill` å‘½ä»¤åœ¨ `git bash for win` ä¸­å¿…é¡»ä»¥åŒæ–œæ ä¼ å‚ï¼ˆ[source][tasklist-in-git-bash]ï¼‰ã€‚

[Nginx-api]:http://nginx.org/en/docs/windows.html

[nginx-clp]:http://nginx.org/en/docs/switches.html

[tasklist-in-git-bash]:https://stackoverflow.com/questions/34981745/taskkill-pid-not-working-in-gitbash

### ä»£ç†åŸºç¡€é…ç½®

1. åœ¨ `host` æ–‡ä»¶ä¸­æ˜ å°„åŸå§‹è¯·æ±‚åœ°å€ã€‚ç¤ºä¾‹ï¼š

```powershell
# ç”¨äºå°† example.com è§£æä¸º 127.0.0.1ï¼ŒåŸç†æ˜¯ PC é¦–å…ˆåœ¨æœ¬åœ° host æ–‡ä»¶ä¸­è§£æ URL
127.0.0.1 example.com
```

2. å•ç‹¬é…ç½® `servers/example.conf`ï¼Œä»¥æ¨¡å—åŒ– `Nginx` ä»£ç†é…ç½®ã€‚

æ‹“å±•ï¼š`http` æ˜¯æ˜æ–‡ä¼ è¾“ï¼Œæ•…å¯åœ¨ä»£ç†å±‚ä¿®æ”¹åŸå§‹è¯·æ±‚çš„è¯·æ±‚é¦–éƒ¨å’Œå†…å®¹ã€‚

```nginx
# æ¯ä¸ªä»£ç†æœåŠ¡éƒ½åœ¨ä¸€ä¸ª server ä¸­å®šä¹‰
server {
  # ç›‘å¬çš„ç«¯å£
  listen      80;
  # ç›‘å¬çš„ URLï¼Œå³ç”¨æˆ·è¾“å…¥çš„ URL
  server_name test.com;
  
  # è½¬å‘çš„ç›®æ ‡åœ°å€
  location / {
    # 1. ä»£ç†å±‚æ¥å—åˆ°åŸå§‹è¯·æ±‚åï¼Œå°†å‘èµ·ä¸€ä¸ªæ–°çš„è¯·æ±‚è‡³ä»£ç†è·¯å¾„ã€‚ä¾æ® HTTP åŸåˆ™ï¼Œè¯¥æ–°çš„è¯·
    # æ±‚çš„ host é»˜è®¤ä¸º proxy_passã€‚
    # æ³¨ï¼šå¯äºç»ˆç«¯ server æ‰“å°å¹¶æŸ¥çœ‹æ–°è¯·æ±‚çš„ host è¯·æ±‚é¦–éƒ¨ã€‚
    proxy_pass http://127.0.0.1:8800;
    # 2. æ¢å¤åŸå§‹è¯·æ±‚çš„ host è¯·æ±‚é¦–éƒ¨ã€‚å˜é‡ $host å³åŸå§‹è¯·æ±‚çš„ host è¯·æ±‚é¦–éƒ¨ã€‚
    # æ³¨ï¼šç»æµè§ˆå™¨æ§åˆ¶å° network tag å¯æŸ¥çœ‹åŸå§‹è¯·æ±‚çš„ host è¯·æ±‚é¦–éƒ¨
    proxy_set_header Host $host;
  }
}
```

ä»¥ä¸Šé…ç½®å°†å®ç° `example.com ==è½¬å‘è‡³==> http://127.0.0.1:8800`ã€‚

***æ³¨***ï¼Œä»£ç†æœåŠ¡å™¨æ ¹æ®åŸå§‹è¯·æ±‚çš„ `host` è¯·æ±‚é¦–éƒ¨æ¥ ***é€‰æ‹©*** ä»£ç†çš„ç›®æ ‡è·¯å¾„ã€‚å³å¯ä»¥å®ç°ä¸€ä¸ªç«¯å£ç›‘å¬ï¼Œå¤šä¸ªè·¯å¾„ä»£ç†ã€‚

### ç¼“å­˜åŠŸèƒ½

```nginx
# proxy_cache_path é…ç½®ç¼“å­˜å­˜æ”¾è·¯å¾„
# levels é…ç½®ç”Ÿæˆå¤šçº§æ–‡ä»¶å¤¹ï¼Œä½¿å¾—å¤šä¸ªä»£ç†åˆ†ç¦»ä¸ºè‡ªå·±ç‹¬ç«‹çš„æ–‡ä»¶å¤¹
# keys_zone é…ç½®åœ¨å†…å­˜ä¸­åˆ†é…ç»™åŒ¹é…çš„ç¼“å­˜ï¼ˆå› ä¸ºåŒ¹é…çš„ç¼“å­˜å°†æš‚å­˜åœ¨å†…å­˜ä¸­ï¼‰çš„åŒºåŸŸåç§°å’Œå¤§å°
proxy_cache_path cache levels=1:2 keys_zone=my_cache:10m; # 2 çº§ç›®å½•ï¼Œå†…å­˜ 10m

server {
  listen      80;
  server_name test.com;
  
  location / {
    proxy_cache my_cache; # æ ¹æ®åå­— my_caches é…ç½®ç¼“å­˜å­˜å‚¨çš„åŒºåŸŸ
    proxy_pass http://127.0.0.1:8800;
    proxy_set_header Host $host;
  }
}
```

ä»£ç†ç¼“å­˜çš„åº”ç”¨åœºæ™¯ï¼šåªè¦ä¸€æ¬¡ä»£ç†ç¼“å­˜ï¼Œé‚£ä¹ˆåç»­åœ¨ç¼“å­˜æœ‰æ•ˆæœŸå†…æ‰€æœ‰è¯·æ±‚åˆ°ä»£ç†æœåŠ¡å™¨çš„è¯·æ±‚éƒ½å¯ä½¿ç”¨è¯¥ç¼“å­˜ï¼Œé‚£ä¹ˆå¯å¤§å¤§èŠ‚çº¦å‘çœŸæ­£èµ„æºæœåŠ¡å™¨è¯·æ±‚çš„æ•°é‡ä¸æ—¶é—´ã€‚

ä¸ä»£ç†ç¼“å­˜ç›¸å…³çš„å“åº”é¦–éƒ¨ï¼ˆå¯¹äº `client` æ¥è¯´ï¼‰

1. `Cache-Control`

    - `s-maxage`: åŠŸèƒ½ä¸ `max-age` ç›¸åŒï¼Œä¸” `s-maxage` è¦†ç›– `max-age`ã€‚äºŒè€…åŒºåˆ«åœ¨äº `s-maxage` é€‚ç”¨å¯¹è±¡ä»…é™å…±äº«ç¼“å­˜çš„å¯¹è±¡ï¼Œå¦‚ä¸­è½¬ä»£ç†æœåŠ¡å™¨ã€‚

    - `private`ï¼šæ ‡æ³¨åªå…è®¸ `client` ç¼“å­˜æ•°æ®ï¼Œä¸­è½¬ä»£ç†æœåŠ¡å™¨ä¸èƒ½ç¼“å­˜è¯¥æ•°æ®ã€‚

    ```js
    // èµ„æºæœåŠ¡å™¨
    response.writeHead(200, {
      // private å°†å¯¼è‡´ max-age å’Œ s-maxage å¤±æ•ˆ
      'Cache-Control': 'max-age=2, s-maxage=20, private'
    })
    ```

    - `no-store`ï¼šè·¯å¾„ä¸­æ‰€æœ‰èŠ‚ç‚¹ï¼ˆåŒ…å« `client`ï¼‰éƒ½ä¸èƒ½ç¼“å­˜è¯¥å“åº”æ•°æ®ã€‚

    ```js
    // èµ„æºæœåŠ¡å™¨
    response.writeHead(200, {
      // no-store å°†å¯¼è‡´ max-age å’Œ s-maxage å¤±æ•ˆ
      'Cache-Control': 'max-age=2, s-maxage=20, no-store'
    })
    ```

2. `Vary`: `Vary` æŒ‡å®šæŸä¸€ `client` ç«¯è¯·æ±‚å¤´ï¼Œåªæœ‰å½“è¯¥è¯·æ±‚é¦–éƒ¨çš„å€¼ä¸ä¸Šæ¬¡è¯·æ±‚é¦–éƒ¨çš„å€¼ç›¸ç­‰æ—¶ï¼Œæ‰ç¼“å­˜å“åº”æ•°æ®ã€‚

    ```js
    // client
    const index = 0

    fetch('/data', {
      headers: {
        // åªæœ‰å½“æ­¤æ¬¡ `x-test-Cache` çš„å€¼ä¸ä¸Šæ¬¡è¯·æ±‚ç›¸åŒæ—¶ï¼Œæ‰ç¼“å­˜æ­¤æ¬¡å“åº”æ•°æ®
        'X-test-Cache': index++
      }
    })
    ```

    ```js
    // èµ„æºæœåŠ¡å™¨
    response.writeHead(200, {
      'Cache-Control': 's-maxage=200',
      // åªæœ‰å½“ `Vary` æ‰€æ ‡æ³¨çš„è¯·æ±‚é¦–éƒ¨å½“æ¬¡å€¼ä¸ä¸Šæ¬¡è¯·æ±‚æ—¶çš„å€¼ç›¸åŒæ—¶ï¼Œæ‰ç¼“å­˜å½“å‰å“åº”æ•°æ®
      'Vary': 'X-test-Cache'
    })
    ```

é€‚ç”¨åœºæ™¯ï¼šåœ¨åŒä¸€ URL æƒ…å†µä¸‹ï¼Œæ ¹æ®ä¸åŒçš„ `userAgent` æ¥ç¼“å­˜ä¸åŒçš„å“åº”æ•°æ®ã€‚æ¯”å¦‚æ ¹æ®ç§»åŠ¨ç«¯ä¸ PC ç«¯è¿”å›ä¸åŒçš„æ•°æ®ã€‚

## HTTPS

`HTTP` æ˜¯æ˜æ–‡ä¼ è¾“ï¼Œä¸ºäº†å¯†æ–‡ä¼ è¾“ï¼Œè¯ç”Ÿäº† `HTTPS`ã€‚

### åŠ å¯†ä¸è§£å¯†

å…¬é’¥ï¼ˆå³æœåŠ¡ç«¯è¯ä¹¦ï¼‰ç”¨äºåŠ å¯†è¢«ä¼ è¾“çš„æ•°æ®ã€‚ç§é’¥ç”¨äºè§£å¯†è¢«ä¼ è¾“çš„æ•°æ®ã€‚

åœ¨æ¡æ‰‹é˜¶æ®µï¼Œè¿›è¡Œå…¬é’¥ä¸ç§é’¥åŒ¹é…ã€‚`client` å°†åœ¨æœ€åˆé˜¶æ®µä¼ è¾“åŠ å¯†å¥—ä»¶ï¼Œç”¨äºä¸ `server` ç«¯å†…å®¹åå•†ï¼ˆ[source][content-negotiation]ï¼‰é€‰æ‹©æœ€ç»ˆä½¿ç”¨çš„åŠ å¯†æ–¹å¼ã€‚ç§é’¥å§‹ç»ˆä¿æŒåœ¨ `server` ç«¯ï¼Œç”¨äºè§£å¯†ï¼Œé‚£ä¹ˆæ®æ­¤ä¿è¯äº†ä¼ è¾“çš„å®‰å…¨æ€§ã€‚

![https-principle][https-principle]

[content-negotiation]:https://developer.mozilla.org/en-US/docs/Web/HTTP/Content_negotiation

[https-principle]:https://rawgit.com/lbwa/lbwa.github.io/vue/source/images/post/http-protocol/https-principle.svg

### éƒ¨ç½²

1. ç”Ÿæˆè¯ä¹¦ï¼ˆ[æœ¬åœ°ç”Ÿæˆè¯ä¹¦å‘½ä»¤][generate-localhost-certificates]ï¼‰

[generate-localhost-certificates]:https://gist.github.com/lbwa/5607c3a66573610b5ccfd4ef4aaa780f

2. é…ç½® `Nginx` ä»£ç†

ï¼ˆ[reference][nginx-https-server]ï¼‰

```nginx
proxy_cache_path cache levels=1:2 keys_zone=my_cache:10m;

server {
  # https é»˜è®¤ç«¯å£æ˜¯ 443
  listen      443 ssl;
  server_name test.com;

  # ssl on; äº 1.15 ç‰ˆæœ¬ä¸­åºŸå¼ƒï¼Œlisten <port> ssl ä»£æ›¿
  ssl_certificate_key ../certs/localhost-privkey.pem;
  ssl_certificate ../certs/localhost-cert.pem;

  location / {
    proxy_cache my_cache;
    proxy_pass http://127.0.0.1:8800;
    proxy_set_header Host $host;
  }
}
```

[nginx-https-server]:http://nginx.org/en/docs/http/configuring_https_servers.html

è¡¥å……ï¼šå°† `HTTP` è½¬å‘è‡³ `HTTPS`

```nginx
# åœ¨ éƒ¨ç½².2 çš„åŸºç¡€ä¸Šå®ç°

server {
  listen      80 default_server;
  listen       [::]:80 default_server;
  server_name test.com;

  # $server_name æ¥å—è¯·æ±‚çš„æœåŠ¡å™¨çš„åç§°ï¼Œæ­¤å¤„å³æ˜¯ test.com
  # $request_uri åŸå§‹å®Œæ•´çš„è¯·æ±‚ URLï¼ŒåŒ…å«æŸ¥è¯¢å‚æ•°ï¼Œå³è®¿é—®ä¸»æœºä¸Šçš„è·¯å¾„ï¼Œå¦‚ /api/data
  return 302 https://$server_name$request_uri;
}
```

## HTTP 2

1. ä¿¡é“å¤ç”¨ï¼Œåœ¨å•ä¸ª `TCP` é€šé“å†…å¯ ***å¹¶å‘è¯·æ±‚***ï¼Œä½†åœ¨ `HTTP 1.1` ä¸­å•ä¸ª `TCP` é€šé“å†…æ˜¯ä¸²è¡Œè¯·æ±‚ã€‚

2. åˆ†å¸§ä¼ è¾“ï¼Œæ¯å¸§ä»¥åŒ…å«ä¸Šä¸‹æ–‡çš„å½¢å¼ä¼ è¾“ï¼Œè¿‡ç¨‹ä¸­ä¸ä¸€å®šæ˜¯æŒ‰ç…§é¡ºåºä¼ è¾“çš„ã€‚å› ä¸ºåŒ…å«ä¸Šä¸‹æ–‡ï¼Œæ•…åœ¨å“åº”ç«¯ï¼Œå¯æ ¹æ®ä¸Šä¸‹æ–‡é‡ç»„å„å¸§è¿˜åŸæ•°æ®ã€‚

3. Server Pushï¼Œ`server` ç«¯ä¸å†æ˜¯åªæœ‰è¢«åŠ¨æ¥å—è¯·æ±‚æ‰èƒ½å“åº”ï¼Œ`server` ç«¯åœ¨ `HTTP 2` ä¸­å¯ä¸»åŠ¨æ¨é€æ•°æ®è‡³ `client`ã€‚

### éƒ¨ç½²

ï¼ˆ[reference][nginx-http-v2]ï¼‰

åœ¨ `HTTP 2` æ ‡å‡†ä¸­ï¼Œ`HTTP 2` å¹¶ä¸å¼ºåˆ¶ä½¿ç”¨ `HTTPS`ã€‚å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œç›®å‰æµè§ˆå™¨éƒ½è¦åœ¨å¼€å¯ `HTTPS` çš„æƒ…å†µä¸‹æ‰èƒ½ä½¿ç”¨ `HTTP 2`ã€‚

```nginx
# ä¸­è½¬æœåŠ¡å™¨
server {
  listen             443 ssl http2;
  server_name        test.com;
  # æŒ‡å®šä¸»åŠ¨æ¨é€
  http2_push_preload on;
  # ...
}
```

[nginx-http-v2]:http://nginx.org/en/docs/http/ngx_http_v2_module.html

- æŸ¥çœ‹ `server` ç«¯ä¸»åŠ¨æ¨é€çš„ç›¸å…³ä¿¡æ¯ï¼Œäºåœ°å€æ è¾“å…¥ `chrome://net-internals/#http2` æŸ¥çœ‹ã€‚

- æ³¨ï¼šæµè§ˆå™¨åªä¼šæ¥å—å®‰å…¨çš„è®¤è¯è¿‡è¯ä¹¦çš„ `server` ç«¯æ¨é€çš„ä¿¡æ¯ï¼Œå¦åˆ™ä¸»åŠ¨æ¨é€ä¿¡æ¯å°†è¢«å¿½ç•¥ã€‚

è¡¥å……ï¼š`HTTPS` vs `HTTP 1.1` vs `HTTP 2` [demo][comparison-demo]

***æ³¨***ï¼š`Nginx` ä»£ç†æœåŠ¡å™¨å¯ä»¥ä¸º `HTTP 2` åšå…¼å®¹ï¼Œä»–ä¼šæ ¹æ® `client` ç«¯æ‰€æ”¯æŒçš„åè®®è¿”å›å“åº”æ•°æ®ï¼Œè€Œä¸éœ€è¦å¼€å‘äººå‘˜æ¥åšåè®®å…¼å®¹ã€‚

[comparison-demo]:https://http2.akamai.com/demo/http2-lab.html
